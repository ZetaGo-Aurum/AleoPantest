from typing import Dict, Any, List
from aleopantest.core.base_tool import BaseTool, ToolMetadata, ToolCategory
import subprocess
import shutil

class SearchSploitWrapper(BaseTool):
    """
    Wrapper untuk tool searchsploit (Exploit Database)
    """
    
    def __init__(self):
        metadata = ToolMetadata(
            name="SearchSploit Wrapper",
            category=ToolCategory.EXPLOIT,
            version="3.0.0",
            author="Aleocrophic Team",
            description="Searches for exploits in the local Exploit Database",
            usage="aleopantest run searchsploit --query 'apache 2.4.49'",
            requirements=["exploitdb"],
            tags=["exploit", "vulnerability", "searchsploit"],
            form_schema=[
                {
                    "name": "query",
                    "type": "text",
                    "label": "Search Query",
                    "placeholder": "e.g. windows 10, apache, etc.",
                    "required": True
                }
            ]
        )
        super().__init__(metadata)

    def run(self, query: str, **kwargs) -> Dict[str, Any]:
        self.logger.info(f"Searching for exploits matching: {query}")
        
        # Check if searchsploit is installed
        if not shutil.which("searchsploit"):
            return {
                "status": "error", 
                "message": "searchsploit not found. Please install exploitdb package."
            }
            
        try:
            # Run searchsploit command
            process = subprocess.run(
                ["searchsploit", "--json", query],
                capture_output=True,
                text=True,
                check=True
            )
            import json
            results = json.loads(process.stdout)
            return {
                "status": "success",
                "query": query,
                "results": results.get("RESULTS_EXPLOIT", [])
            }
        except Exception as e:
            return {"status": "error", "message": f"SearchSploit execution failed: {str(e)}"}

def get_tool():
    return SearchSploitWrapper()
